"use strict";var e=require("path"),n=process.cwd(),r=require(e.join(n,"settings")),t=require("node-uuid"),u=require("speedt-utils").md5,i=require("speedt-utils").utils,o=require("emag.db").mysql,c=require("emag.db").redis,s=require("emag.cfg"),d=require("emag.biz"),l=require("underscore");l.str=require("underscore.string"),l.mixin(l.str.exports()),function(){function e(e,n){return e<=n.gold_count?Promise.resolve():Promise.reject("元宝不足")}function n(e,n,t,i){return new Promise(function(s,d){r(e,t,i).then(u.bind(null,n,t,i)).then(c.bind(null,e,n,t,i)).then(o.commitTransaction.bind(null,i)).then(function(){return s()}).catch(function(e){i.rollback(function(){return d(e)})})})}function r(e,n,r){return new Promise(function(t,u){r.query(s,[n,e],function(e){if(e)return u(e);t()})})}function u(e,n,r){return new Promise(function(t,u){r.query(f,[n,e],function(e){if(e)return u(e);t()})})}function c(e,n,r,u){return new Promise(function(o,c){u.query(m,[i.replaceAll(t.v1(),"-",""),e,n,new Date,r],function(e){if(e)return c(e);o()})})}var s="UPDATE s_user SET gold_count=gold_count-? WHERE id=?",f="UPDATE s_user SET gold_count=gold_count+? WHERE id=?",m="INSERT INTO s_user_transfer (id, source_id, target_id, create_time, gold_num) VALUES (?, ?, ?, ?, ?)";exports=module.exports=function(r,t,u){return u-=0,l.isNumber(u)?1>u?Promise.reject("INVALID_PARAMS"):new Promise(function(i,c){d.user.getById(r).then(e.bind(null,u)).then(d.user.getById.bind(null,t)).then(o.beginTransaction.bind(o)).then(n.bind(null,r,t,u)).then(function(){return i()}).catch(c)}):Promise.reject("INVALID_PARAMS")}}();