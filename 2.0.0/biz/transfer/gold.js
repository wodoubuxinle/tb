"use strict";var e=require("path"),n=process.cwd(),r=require(e.join(n,"settings")),t=require("node-uuid"),i=require("speedt-utils").md5,u=require("speedt-utils").utils,o=require("emag.db").mysql,c=require("emag.db").redis,s=require("emag.cfg"),d=require("emag.biz"),l=require("underscore");l.str=require("underscore.string"),l.mixin(l.str.exports()),function(){function e(e,n){return e<=n.gold_count?Promise.resolve():Promise.reject("元宝不足")}function n(e,n,t,u){return new Promise(function(s,d){r(e,t,u).then(i.bind(null,n,t,u)).then(c.bind(null,e,n,t,u)).then(o.commitTransaction.bind(null,u)).then(function(){return s()}).catch(function(e){u.rollback(function(){return d(e)})})})}function r(e,n,r){return new Promise(function(t,i){r.query(s,[n,e],function(e){if(e)return i(e);t()})})}function i(e,n,r){return new Promise(function(t,i){r.query(f,[n,e],function(e){if(e)return i(e);t()})})}function c(e,n,r,i){return new Promise(function(o,c){i.query(m,[u.replaceAll(t.v1(),"-",""),e,n,new Date,r],function(e){if(e)return c(e);o()})})}var s="UPDATE s_user SET gold_count=gold_count-? WHERE id=?",f="UPDATE s_user SET gold_count=gold_count+? WHERE id=?",m="INSERT INTO s_user_transfer (id, source_id, target_id, create_time, gold_num) VALUES (?, ?, ?, ?, ?)";exports=module.exports=function(r,t,i){return r===t?Promise.reject("INVALID_PARAMS"):(i-=0,l.isNumber(i)?1>i?Promise.reject("INVALID_PARAMS"):new Promise(function(u,c){d.user.getById(r).then(e.bind(null,i)).then(d.user.getById.bind(null,t)).then(o.beginTransaction.bind(o)).then(n.bind(null,r,t,i)).then(function(){return u()}).catch(c)}):Promise.reject("INVALID_PARAMS"))}}();