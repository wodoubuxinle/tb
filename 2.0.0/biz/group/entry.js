"use strict";var e=require("path"),r=process.cwd(),t=require(e.join(r,"settings")),i=require("node-uuid"),n=require("speedt-utils").md5,u=require("speedt-utils").utils,s=require("emag.db").mysql,o=require("emag.db").redis,a=require("emag.cfg"),d=require("emag.biz"),l=require("underscore");l.str=require("underscore.string"),l.mixin(l.str.exports());var c=require("emag.model").roomPool;!function(){function e(e,r){return r.group_id?Promise.reject("MUST_BE_QUIT"):(r.group_id=e,Promise.resolve(r))}function r(e,r){var t=e.entry(r);if("string"==typeof t)return Promise.reject(t);var i=[],n=!0,u=!1,s=void 0;try{for(var o,a=l.values(e.getUsers())[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var d=o.value;i.push([d.id,d.opts.seat,d.nickname,d.weixin_avatar])}}catch(e){u=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(u)throw s}}return Promise.resolve([e.getUsers(),i])}exports=module.exports=function(t,i,n){var u=c.get(n);return u?new Promise(function(s,o){d.user.getByChannelId(t,i).then(e.bind(null,n)).then(d.user.entryGroup).then(r.bind(null,u)).then(function(e){return s(e)}).catch(o)}):Promise.reject("群组不存在")}}();