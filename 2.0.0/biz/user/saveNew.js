"use strict";var e=require("path"),n=process.cwd(),r=require(e.join(n,"settings")),u=require("node-uuid"),o=require("speedt-utils").md5,s=require("speedt-utils").utils,t=require("emag.db").mysql,i=require("emag.db").redis,c=require("emag.cfg"),_=require("emag.biz"),a=require("underscore");a.str=require("underscore.string"),a.mixin(a.str.exports()),function(){function e(e){return e?Promise.reject("用户名已存在"):Promise.resolve()}function n(e,n){return e.id=n,e.user_pass=o.hex(e.user_pass||"123456"),e.status=1,e.create_time=new Date,e.current_score=0,e.vip=0,e.consume_count=0,e.win_count=0,e.lose_count=0,e.win_score_count=0,e.lose_score_count=0,e.line_gone_count=0,e.gold_count=e.gold_count||20,e.sex=e.sex||0,new Promise(function(n,u){t.query(r,[e.id,e.user_name,e.user_pass,e.status,e.create_time,e.mobile,e.wx_openid,e.wx_unionid,e.wx_pass,e.wx_avatar,e.wx_original,e.current_score,e.nickname,e.vip,e.consume_count,e.win_count,e.lose_count,e.win_score_count,e.lose_score_count,e.line_gone_count,e.gold_count,e.sex],function(r){if(r)return u(r);n(e)})})}exports=module.exports=function(r,u){return new Promise(function(u,o){_.user.getByName(r.user_name).then(e).then(_.user.genId).then(n.bind(null,r)).then(function(){return u(r)}).catch(o)})};var r="INSERT INTO s_user (id, user_name, user_pass, status, create_time, mobile, wx_openid, wx_unionid, wx_pass, wx_avatar, wx_original, current_score, nickname, vip, consume_count, win_count, lose_count, win_score_count, lose_score_count, line_gone_count, gold_count, sex) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"}();