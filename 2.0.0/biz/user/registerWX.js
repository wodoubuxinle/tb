"use strict";var e=require("path"),i=process.cwd(),n=require(e.join(i,"settings")),r=require("node-uuid"),u=require("speedt-utils").md5,t=require("speedt-utils").utils,s=require("speedt-anysdk"),a=require("emag.db").mysql,o=require("emag.db").redis,c=require("emag.cfg"),d=require("emag.biz"),m=require("underscore");m.str=require("underscore.string"),m.mixin(m.str.exports()),function(){function e(e){var n=m.clone(e);return new Promise(function(r,u){d.user.getByName(e.data.user_info.unionid).then(i.bind(null,e.data.user_info)).then(function(){return r(n)}).catch(u)})}function i(e,i){return i?(i.weixin_original=JSON.stringify(e),i.nickname=e.nickname,i.sex=e.sex,i.weixin_avatar=e.headimgurl,i.user_name=e.unionid,new Promise(function(e,n){a.query(r,[i.nickname,i.sex,i.weixin_original,i.weixin_avatar,i.user_name],function(r){if(r)return n(r);e(i)})})):n(e)}function n(e){return e.weixin_original=JSON.stringify(e),e.user_name=e.unionid,e.user_pass="123456",e.weixin_avatar=e.headimgurl,d.user.saveNew(e)}exports=module.exports=function(i){return new Promise(function(n,r){s.wx(i).then(e).then(function(e){return n(e)}).catch(r)})};var r="UPDATE s_user SET nickname=?, sex=?, weixin_original=?, weixin_avatar=? WHERE user_name=?"}();