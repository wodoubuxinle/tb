"use strict";var t=require("path"),e=process.cwd(),r=require(t.join(e,"settings")),s=require("node-uuid"),i=require("speedt-utils").utils,n=require("underscore");n.str=require("underscore.string"),n.mixin(n.str.exports());var u=function(t,e){if(!e.group_id)throw new Error("group id cannot be empty");var r=this;r.id=e.group_id,r.name=t.name||"Room "+r.id,r._users={},r._players={},r.create_user_id=e.id,r.create_time=(new Date).getTime(),r.visitor_count=t.visitor_count||0,r._player_count=t.player_count||4,function(){r._free_seat=[];for(var t=1;t<=r._player_count;t++)r._free_seat.push(t)}(),r.entry(e)},o=u.prototype;o.getNextSeatBySeat=function(t){return t-=0,this._player_count<++t?1:t},o.getUser=function(t){return this._users[t]},o.getUsers=function(){return this._users},o.getUserBySeat=function(t){return this._players[t]},o.isPlayer=function(t){return 0<t.opts.seat},o.isReady=function(t){return 0<t.opts.is_ready},o.isQuit=function(t){return 0<t.opts.is_quit},o.isStart=function(){return this._player_count<=this.getReadyCount()},o.getReadyCount=function(){var t=0,e=!0,r=!1,s=void 0;try{for(var i,u=n.values(this._players)[Symbol.iterator]();!(e=(i=u.next()).done);e=!0){var o=i.value;this.isReady(o)&&++t}}catch(t){r=!0,s=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw s}}return t},o.release=function(){return 1>this.getUserCount()},o.getUserCount=function(){return n.size(this._users)},o.isFull=function(){return this._player_count+this.visitor_count<=this.getUserCount()},function(){function t(t){var e=this._free_seat.shift();0<e&&(this._players[e]=t,t.opts.seat=e)}o.entry=function(e){var r=this;return r.getUser(e.id)?"已在房间":r.isFull()?"房间满员":(e.opts={},t.call(r,e),r._users[e.id]=e,e.opts.entry_time=(new Date).getTime(),e.opts.is_quit=0,e.opts.is_ready=0,e)}}(),o.quit=function(t){var e=this,r=e.getUser(t);if(!r)return!0;if(e.isPlayer(r)){if(e.isStart())return r.opts.quit_time=(new Date).getTime(),r.opts.is_quit=1,!1;e._free_seat.push(r.opts.seat),delete e._players[r.opts.seat]}return delete e._users[t]},exports=module.exports=u;