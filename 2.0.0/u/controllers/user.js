"use strict";var e=require("emag.biz"),r=require("../settings"),n=require("speedt-utils").utils,s=require("request"),t=require("log4js").getLogger("controllers.user");exports.loginUI=function(e,n,s){n.render("user/login",{conf:r,data:{}})},exports.login=function(r,n,s){var t=r.body;e.user.loginBack(t).then(function(e){r.session.userId=e.id,r.session.user=e,n.send({})}).catch(function(e){if("string"!=typeof e)return s(e);n.send({error:{msg:e}})})},exports.login_validate=function(e,n,s){return e.session.userId?s():e.xhr?n.send({error:{msg:"无权访问"}}):void n.redirect(r.html.virtualPath+"login?refererUrl="+escape(r.html.virtualPath+e.url.substr(1)))},exports.logoutUI=function(e,n,s){e.session.destroy(),n.redirect(r.html.virtualPath+"login")},exports.changePwdUI=function(e,n,s){n.render("user/changePwd",{conf:r,description:"",keywords:",html5,nodejs"})},exports.changePwd=function(r,n,s){var t=r.body;t.id=r.session.userId,e.user.changePwd(t).then(function(){n.send({})}).catch(function(e){if("string"!=typeof e)return s(e);n.send({error:{msg:e}})})},exports.friendsUI=function(n,s,t){e.user.findAllByChild(n.session.userId).then(function(e){s.render("user/friends",{conf:r,description:"",keywords:",html5,nodejs",data:{friends:e}})}).catch(t)},exports.resetPwd=function(r,n,s){var t=r.body;e.user.resetPwd(t.id,"123456",function(e){if(e)return s(e);n.send({})})},exports.transRecordUI=function(n,s,t){e.transfer.findGoldBySource(n.session.userId).then(function(e){s.render("user/transRecord",{conf:r,description:"",keywords:",html5,nodejs",data:{records:e}})}).catch(t)},exports.transferUI=function(e,n,s){n.render("user/transfer",{conf:r,description:"",keywords:",html5,nodejs"})},exports.transfer=function(r,n,s){var t=r.body;e.transfer.gold(r.session.userId,t.target_id,t.gold_num).then(function(){n.send({})}).catch(function(e){if("string"!=typeof e)return s(e);n.send({error:{msg:e}})})};