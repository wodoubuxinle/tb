"use strict";function r(r){if(u.isString(r))return u.trim(r)}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},n=require("path"),o=process.cwd(),t=require(n.join(o,"settings")),i=require("emag.biz"),u=require("underscore");u.str=require("underscore.string"),u.mixin(u.str.exports());var a=require("emag.model").roomPool,c=require("log4js").getLogger("handle");exports.one_for_one=function(r,e){try{var n=JSON.parse(e)}catch(r){return}var o=[n.channelId,JSON.stringify([2002,n.data,u.now()])];r("/queue/back.send.v3."+n.serverId,{priority:9},o,function(r){if(r)return c.error("chat one_for_one:",r)})},function(){function n(r,e,n){if(n.group_id){var o=a.get(n.group_id);if(o&&!o.release()){var t=[null,JSON.stringify([2004,[n.id,e.data],u.now(),e.seqId])],i=!0,f=!1,s=void 0;try{for(var d,l=u.values(o.getUsers())[Symbol.iterator]();!(i=(d=l.next()).done);i=!0){var y=d.value;y.server_id&&y.channel_id&&(t.splice(0,1,y.channel_id),r("/queue/back.send.v3."+y.server_id,{priority:9},t,function(r,e){if(r)return c.error("chat one_for_group:",r)}))}}catch(r){f=!0,s=r}finally{try{!i&&l.return&&l.return()}finally{if(f)throw s}}}}}function o(r,n,o){if("object"===(void 0===o?"undefined":e(o)))return c.error("chat one_for_group:",o);c.debug("chat one_for_group:",o)}exports.one_for_group=function(e,t){try{var u=JSON.parse(t)}catch(r){return}u.data=r(u.data),u.data&&i.user.getByChannelId(u.serverId,u.channelId).then(n.bind(null,e,u)).catch(o.bind(null,e,u))}}();