"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},e=require("path"),r=process.cwd(),o=require(e.join(r,"settings")),t=require("underscore"),i=require("emag.biz"),c=require("emag.cfg"),u=require("log4js").getLogger("handle.channel");!function(){function e(n,e,r){n("/queue/back.send.v3."+e.serverId,{priority:9},[e.channelId,JSON.stringify([1,o.app.ver,t.now()])],function(n){if(n)return u.error("channel open:",n)})}function r(e,r,o){if("object"===(void 0===o?"undefined":n(o)))return u.error("channel open:",o);u.debug("channel open:",o)}exports.open=function(n,o){var t=o.split("::"),c={serverId:t[0],channelId:t[1]};i.user.registerChannel(c.serverId,c.channelId).then(e.bind(null,n,c)).catch(r.bind(null,n,c))}}(),function(){function e(n,e,r){if(r){var o=[null,JSON.stringify([1004,r[1],t.now(),e.seqId])],i=!0,c=!1,l=void 0;try{for(var a,d=t.values(r[0])[Symbol.iterator]();!(i=(a=d.next()).done);i=!0){var f=a.value;f.server_id&&f.channel_id&&(o.splice(0,1,f.channel_id),n("/queue/back.send.v3."+f.server_id,{priority:9},o,function(n){if(n)return u.error("channel close:",n)}))}}catch(n){c=!0,l=n}finally{try{!i&&d.return&&d.return()}finally{if(c)throw l}}}}function r(e,r,o){if("object"===(void 0===o?"undefined":n(o)))return u.error("channel close:",o);u.debug("channel close:",o)}exports.close=function(n,o){var t=o.split("::"),c={serverId:t[0],channelId:t[1]};i.user.logout(c.serverId,c.channelId).then(e.bind(null,n,c)).catch(r.bind(null,n,c))}}(),function(){function e(n,e,r){n("/queue/back.send.v3."+e.serverId,{priority:9},[e.channelId,JSON.stringify([1002,r,t.now(),e.seqId])],function(n){if(n)return u.error("channel info:",n)})}function r(e,r,o){if("object"===(void 0===o?"undefined":n(o)))return u.error("channel info:",o);u.debug("channel info:",o)}exports.info=function(n,o){try{var t=JSON.parse(o)}catch(n){return}i.user.getByChannelId(t.serverId,t.channelId).then(e.bind(null,n,t)).catch(r.bind(null,n,t))}}();