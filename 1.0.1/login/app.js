"use strict";function e(){process.exit(0)}var r=require("express"),s=require("connect-flash"),o=require("velocityjs"),n=require("fs"),t=require("http"),i=require("path"),u=process.cwd(),c=require("./settings"),a=require("emag.lib").macro,p=require("log4js");p.configure({appenders:{app:{type:"dateFile",filename:i.join(u,"logs","app"),pattern:".yyyy-MM-dd.log",alwaysIncludePattern:!0},console:{type:"console"}},categories:{default:{appenders:["app","console"],level:"debug"}}});var l=p.getLogger("app"),g=r();g.set("port",process.env.PORT||c.app.port).set("views",i.join(__dirname,"views")).set("view engine","html").use(s()).use(r.favicon()).use(r.json()).use(r.urlencoded()).use(r.cookieParser()).use(r.methodOverride()),"production"===g.get("env")&&g.use("/public",r.static(i.join(__dirname,"public"),{maxAge:1e4})).use(r.errorHandler()).use(r.logger("dev")),"development"===g.get("env")&&g.use(r.logger("dev")).use("/public",r.static(i.join(__dirname,"public"))).use(r.errorHandler({dumpExceptions:!0,showStack:!0})),g.use(r.session({secret:c.cookie.secret,key:c.cookie.key,cookie:{maxAge:864e5}})),g.use(g.router).engine(".html",function(e,r,s){n.readFile(e,"utf8",function(e,n){if(e)return s(e);try{s(null,o.render(n,r,a))}catch(e){s(e)}})}),g.use(function(e,r,s,o){return e?r.xhr?s.send({error:{msg:e.message}}):void s.send(500,e.message):o()});var d=t.createServer(g);d.listen(g.get("port"),function(){l.info("login server listening on port %s",g.get("port")),require("./routes")(g)}),process.on("uncaughtException",function(e){l.error("uncaughtException:",e)}),process.on("SIGINT",e),process.on("SIGTERM",e);