"use strict";function e(){process.exit(0)}var r=require("express"),o=require("connect-flash"),s=require("velocityjs"),i=require("fs"),n=require("http"),t=require("path"),u=process.cwd(),c=require("./settings"),a=require("emag.lib").macro,p=require("emag.biz"),l=require("log4js");l.configure({appenders:{app:{type:"dateFile",filename:t.join(u,"logs","app"),pattern:".yyyy-MM-dd.log",alwaysIncludePattern:!0},console:{type:"console"}},categories:{default:{appenders:["app","console"],level:"debug"}}});var g=l.getLogger("app"),d=r();d.set("port",process.env.PORT||c.app.port).set("views",t.join(__dirname,"views")).set("view engine","html").use(o()).use(r.favicon()).use(r.json()).use(r.urlencoded()).use(r.cookieParser()).use(r.methodOverride()),"production"===d.get("env")&&d.use("/public",r.static(t.join(__dirname,"public"),{maxAge:1e4})).use(r.errorHandler()).use(r.logger("dev")),"development"===d.get("env")&&d.use(r.logger("dev")).use("/public",r.static(t.join(__dirname,"public"))).use(r.errorHandler({dumpExceptions:!0,showStack:!0})),d.use(r.session({secret:c.cookie.secret,key:c.cookie.key,cookie:{maxAge:864e5}})),d.use(d.router).engine(".html",function(e,r,o){i.readFile(e,"utf8",function(e,i){if(e)return o(e);try{o(null,s.render(i,r,a))}catch(e){o(e)}})}),d.use(function(e,r,o,s){return e?r.xhr?o.send({error:{code:e.message}}):void o.send(500,e.message):s()});var v=n.createServer(d);v.listen(d.get("port"),function(){g.info("login server listening on port %s",d.get("port")),require("./routes")(d)}),process.on("uncaughtException",function(e){g.error("uncaughtException:",e)}),p.cfg.init(function(e,r){if(e)throw e;g.debug("redis init:",r)}),process.on("SIGINT",e),process.on("SIGTERM",e);