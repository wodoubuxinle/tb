"use strict";function t(t){t=t||36;for(var e=[],r=1,s=0;s<t;s+=4)e[s]=e[s+1]=e[s+2]=e[s+3]=r++;for(var a=t-1,o=0;o<t;o++){var n=Math.round(Math.random()*a);r=e[n],e[n]=e[a],e[a--]=r}return e}function e(t){t=t||8;for(var e=[],r=0;r<t;r++)e.push(this.cards_36.shift());return e}var r=require("assert"),s=require("path"),a=process.cwd(),o=require(s.join(a,"settings")),n=require("node-uuid"),u=require("speedt-utils").utils,i=require("underscore");i.str=require("underscore.string"),i.mixin(i.str.exports());var _=require("log4js").getLogger("model.room"),c=1,p=0,d=0,f=1,l=2,v=3,b=4,h=5,g=11,y=10,m=6,k=7,S=8,B=9;module.exports=function(t){return new U(t)};var U=function(t){var e=this;e.opts=t,e.id=t.id,e.name=t.name||"Room "+t.id,e.users={},e.players={},e.player_count=4,e.create_user_id=t.user_id,e.create_time=(new Date).getTime(),e.act_seat=1,e.act_status=d,e.act_direction=c,e.round_id=u.replaceAll(n.v4(),"-",""),e.round_pno=1,e.round_no=1,e.round_no_first_seat=1,e.round_no_compare=[],e.round_no_compare_seat=1,e.round_no_ready={},e.banker_seat=0,e.banker_bets=[200,300,500],e.visitor_count=0,e.fund=t.fund||1e3,e.round_count=t.round_count||4,e.free_seats=[];for(var r=1;r<=e.player_count;r++)e.free_seats.push(r)},x=U.prototype;x.getBankerBet=function(t){var e=this;if(!(1>e.banker_bets.length)){var r=e.banker_bets.indexOf(t);return 1>r?e.banker_bets.shift():1===r?(e.banker_bets.shift(),e.banker_bets.shift()):2===r?(e.banker_bets.shift(),e.banker_bets.shift(),e.banker_bets.shift()):void 0}},x.getBetSeatCount=function(){var t=0,e=!0,r=!1,s=void 0;try{for(var a,o=i.values(this.users)[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){a.value.opts.bet&&++t}}catch(t){r=!0,s=t}finally{try{!e&&o.return&&o.return()}finally{if(r)throw s}}return t},x.isStart=function(){return this.player_count<=i.size(this.round_no_ready)},x.release=function(){return 1>i.size(this.users)},x.getUser=function(t){return this.users[t]},x.getUserBySeat=function(t){return this.getUser(this.players[t])},x.getUserPrevBySeat=function(t){return this.getUserBySeat(this.getSeatPrevBySeat(t))},x.getUserNextBySeat=function(t){return this.getUserBySeat(this.getSeatNextBySeat(t))},x.getSeatPrevBySeat=function(t){return t-=0,1>--t?this.player_count:t},x.getSeatNextBySeat=function(t){return t-=0,this.player_count<++t?1:t},x.isFull=function(){return this.player_count+this.visitor_count<=i.size(this.users)},x.entry=function(t){var e=this;if(!e.getUser(t.id)&&!e.isFull()){t.opts={score:0};var r=e.free_seats.shift();return r&&(e.players[r]=t.id,t.opts.seat=r),t.opts.entry_time=(new Date).getTime(),e.users[t.id]=t,t}},x.reEntry=function(t){r.notEqual(null,t);var e=this.getUser(t.id);if(e&&!(1>e.opts.seat)&&1===e.opts.is_quit)return e.opts.is_quit=0,e.opts.reEntry_time=(new Date).getTime(),e.server_id=t.server_id,e.channel_id=t.channel_id,e},x.quit=function(t){var e=this,r=e.getUser(t);return!r||(e.isStart()&&0<r.opts.seat?(r.opts.is_quit=1,r.opts.quit_time=(new Date).getTime(),!1):(0<r.opts.seat&&(e.free_seats.push(r.opts.seat),delete e.round_no_ready[r.opts.seat],delete e.players[r.opts.seat]),delete e.users[t],!0))},x.ready=function(e){var r=this;if(r.act_status===d&&!r.isStart()){var s=r.getUser(e);if(s&&!(1>s.opts.seat||r.round_no_ready[s.opts.seat]))return r.round_no_ready[s.opts.seat]=e,r.isStart()&&(r.act_status=f,r.act_seat=r.banker_seat||1,r.cards_36=t()),s}},function(){function t(){}function e(){var t=0,e=!0,r=!1,s=void 0;try{for(var a,o=i.values(this.users)[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){a.value.opts.craps&&t++}}catch(t){r=!0,s=t}finally{try{!e&&o.return&&o.return()}finally{if(r)throw s}}return t}function r(){var t=0,e=0,r=!0,s=!1,a=void 0;try{for(var o,n=i.values(this.users)[Symbol.iterator]();!(r=(o=n.next()).done);r=!0){var u=o.value,_=u.opts.craps[0]-0+u.opts.craps[1];if(11<_)return u.opts.seat;t<=_&&(t=_,e=u.opts.seat)}}catch(t){s=!0,a=t}finally{try{!r&&n.return&&n.return()}finally{if(s)throw a}}return e}x.craps4=function(s){var a=this;if(a.act_status===f){var o=a.getUser(s);if(o&&a.act_seat===o.opts.seat&&!o.opts.craps)return o.opts.craps=[i.random(1,6),i.random(1,6)],a.act_seat=a.getSeatNextBySeat(a.act_seat),a.player_count<=e.call(a)&&(a.act_status=l,a.banker_seat=r.call(a),a.banker_bets=[200,300,500],a.act_seat=a.banker_seat,t.call(a)),o}}}(),x.bankerBet=function(t,e){var r=this;if(r.act_status===l){var s=r.getUser(t);if(s&&r.banker_seat===s.opts.seat)return r.act_status=v,s.opts.score=s.opts.bet=r.getBankerBet(e),s}},function(){function t(t,e){var r=(e[0]+e[1]-1+t)%4;return 0===r?4:r}x.bankerCraps=function(e){var r=this;if(r.act_status===v){var s=r.getUser(e);if(s&&(console.log(r.banker_seat!==s.opts.seat),console.log(r.banker_seat),console.log(s.opts.seat),r.banker_seat===s.opts.seat))return r.act_status=b,s.opts.craps=[i.random(1,6),i.random(1,6)],r.act_seat=r.round_no_first_seat=t(s.opts.seat,s.opts.craps),s}}}(),function(){function t(t){return t}x.unBankerBet=function(e,r){var s=this;if(s.act_status===b){var a=s.getUser(e);if(a&&!a.opts.bet)return-1<r.indexOf(",")||(r-=0,a.opts.bet=t.call(s,r)),a}},x.unBankerBetClosure=function(){var t=this;if(t.act_status===b)return t.act_status=g,t.cards_8=e.call(t),t.round_no_compare.length=0,t.cards_8}}(),x.cardCompareBefore=function(){var t=this;t.act_status===g&&(t.act_status=h)},function(){function t(t,e){var r=[0,0,0];return e.point>t.point?e.point>10?e.gold_count>0&&(r[0]=-e.bet,r[1]=e.bet,r[2]=e.seat):(r[0]=-e.bet,r[1]=e.bet):t.point>10?t.gold_count>0&&(r[0]=e.bet,r[1]=-e.bet,r[2]=t.seat):(r[0]=e.bet,r[1]=-e.bet),r}function e(){var t=this;if(!(2<t.round_no_compare.length))return t.round_no_first_seat===t.banker_seat&&(t.round_no_first_seat=t.getSeatNextBySeat(t.round_no_first_seat)),t.round_no_first_seat}function r(t){var e=this,r=e.cards_8[2*(t-1)],s=e.cards_8[2*(t-1)+1];return r!==s?(r+s)%10:10+r}x.cardCompare=function(){var s=this;if(s.act_status===h){if(s.act_status=y,s.round_no_compare_seat=e.call(s),!s.round_no_compare_seat)return s.act_status=B,"5026";var a=s.getUserBySeat(s.banker_seat),o=s.getUserBySeat(s.round_no_compare_seat),n=t({point:r.call(s,s.banker_seat),bet:a.opts.bet,seat:s.banker_seat,gold_count:a.gold_count-0},{point:r.call(s,s.round_no_compare_seat),bet:o.opts.bet,seat:s.round_no_compare_seat,gold_count:o.gold_count-0});0<n[2]&&s.getUserBySeat(n[2]).gold_count--,s.round_no_compare.push([s.id,a.id+"",s.banker_seat-0,o.id+"",s.round_no_compare_seat-0,s.round_id+"",s.round_pno-0,s.round_no-0,a.gold_count-0,n[0]-0,n[0]-0,n[1]-0,n[1]-0,o.gold_count-0]),_.debug(s.round_no_compare);var u=s.round_no_compare[s.round_no_compare.length-1],i=u[10];if(0>i){var c=a.opts.score+i;0>c?(u[11]=a.opts.score,u[9]=-u[11],u[12]=u[12]-a.opts.score,u[10]=-u[12],a.opts.score=c):0===c?(u[11]=a.opts.score,u[9]=-a.opts.score,a.opts.score=0):a.opts.score=c}else 0<i&&(a.opts.score+=i);return 1>a.opts.score?s.act_status=k:s.act_status=h,s.round_no_first_seat=s.getSeatNextBySeat(s.round_no_compare_seat),s.round_no_compare[s.round_no_compare.length-1]}}}(),x.bankerGoOn=function(t,e,r){var s=this;if(_.debug(e),s.act_status===k){s.act_status=S;var a=s.getUser(t);if(a&&s.banker_seat===a.opts.seat){if(1>e)return s.act_status=l,s.banker_seat=s.getSeatNextBySeat(s.banker_seat),_.debug("3--- %s",s.banker_seat),"5038";var e=s.getBankerBet(e);if(!e)return s.act_status=l,s.banker_seat=s.getSeatNextBySeat(s.banker_seat),_.debug("4--- %s",s.banker_seat),"5034";var o=s.round_no_compare[s.round_no_compare.length-1],n=o[10];if(a.opts.bet=e,a.opts.score=e+n,0>n){var u=a.opts.score+n;_.debug("6--- %s %s %s",u,a.opts.score,n),0>u?(o[11]=a.opts.score,o[9]=-o[11],o[12]=o[12]-a.opts.score,o[10]=-o[12],_.debug("7--- %s",u),a.opts.score=u):0===u?(o[11]=a.opts.score,o[9]=-a.opts.score,_.debug("8--- %s",u),a.opts.score=0):a.opts.score=u}else 0<n&&(a.opts.score+=n);return _.debug("1--- %s",a.opts.score),1>a.opts.score?s.act_status=k:s.act_status=h,_.debug("2--- %s",a.opts.score),a}}},function(){function e(){var t=!0,e=!1,r=void 0;try{for(var s,a=i.values(this.users)[Symbol.iterator]();!(t=(s=a.next()).done);t=!0){if(0<s.value.opts.is_quit)return!0}}catch(t){e=!0,r=t}finally{try{!t&&a.return&&a.return()}finally{if(e)throw r}}}x.roundReady=function(){var r=this;if(r.act_status===B){if(r.round_no++,4<r.round_no&&(r.round_pno++,r.round_no=1,r.cards_36=t()),4<r.round_pno)return"GAME_OVER";if(e.call(r))return"GAME_OVER";r.act_status=v;var s=!0,a=!1,o=void 0;try{for(var n,u=i.values(r.users)[Symbol.iterator]();!(s=(n=u.next()).done);s=!0){var _=n.value;delete _.opts.craps,delete _.opts.bet}}catch(t){a=!0,o=t}finally{try{!s&&u.return&&u.return()}finally{if(a)throw o}}return"ACT_STATUS_ROUND_NO_READY"}}}();