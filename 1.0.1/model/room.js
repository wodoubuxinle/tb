"use strict";function t(t){t=t||36;for(var e=[],a=1,r=0;r<t;r+=4)e[r]=e[r+1]=e[r+2]=e[r+3]=a++;for(var s=t-1,n=0;n<t;n++){var i=Math.round(Math.random()*s);a=e[i],e[i]=e[s],e[s--]=a}return e}function e(t,e){var a=[0,0,0];return e.point>t.point?e.point>10?e.gold>0&&(a[0]=-e.bet,a[1]=e.bet,a[2]=e.seat):(a[0]=-e.bet,a[1]=e.bet):t.point>10?t.gold>0&&(a[0]=e.bet,a[1]=-e.bet,a[2]=t.seat):(a[0]=e.bet,a[1]=-e.bet),a}var a=require("assert"),r=require("path"),s=process.cwd(),n=require(r.join(s,"settings")),i=require("node-uuid"),o=require("speedt-utils").utils,u=require("underscore");u.str=require("underscore.string"),u.mixin(u.str.exports());var _=require("log4js").getLogger("model.room"),c=1,l=0,d="AS_READY",f="AS_PLAYER_DICE",y="AS_DELAY_PLAYER_DICE",p="AS_WAIT_FOR_PLAYER_DICE",h="AS_BANKER_BET",v="AS_DELAY_BANKER_BET",b="AS_WAIT_FOR_BANKER_BET",m="AS_BANKER_DICE",g="AS_DELAY_BANKER_DICE",k="AS_WAIT_FOR_BANKER_DICE",A="AS_WAIT_FOR_BANKER_CONTINUE_DICE",S="AS_PLAYER_BET",E="AS_DELAY_PLAYER_BET",U="AS_WAIT_FOR_PLAYER_BET",R="AS_DELAY_DEALCARD",B="AS_COMPARE_CARD",C="AS_DELAY_COMPARE_CARD",D="AS_DELAY_COMPARE_CARD2",N="AS_DELAY_COMPARE_CARD3",T="AS_BANKER_CONTINUE_BET",O="AS_WAIT_FOR_BANKER_CONTINUE_BET",x="AS_DELAY_BANKER_CONTINUE_BET",I="AS_RESULT",w="AS_WAIT_FOR_NEXT_ROUND",L="AS_WAIT_FOR_NEXT_ROUND2",Y="AS_DELAY_NEXT_ROUND",P="AS_WAIT_FOR_BANKER_CONTINUE",q="AS_DELAY_BANKER_CONTINUE",F="AS_GAMEOVER";module.exports=function(t){return new K(t)};var K=function(t){var e=this;e.opts=t,e.id=t.id,e.name=t.name||"Room "+t.id,e._users={},e._players={},e.create_user_id=t.user_id,e.create_time=(new Date).getTime(),e.act_seat=1,e.act_status=d,e._act_direction=c,e._free_seat=[1,2,3,4],e._player_count=e._free_seat.length,e.visitor_count=t.visitor_count||0,e.fund=t.fund||1e3,e.curr_fund=0,e.round_count=t.round_count||4,e.round_num=0,e.hand_num=1,e.result=[],e.banker_seat=0,e.first_seat=1,e.compare_seat=1,e.banker_bet=0,e.chips=[2e3,3e3,5e3],e.delaytime=0,e.specialflag=0},W=K.prototype;W.setHacke=function(t){this._users[t].opts.hacker=!0},W.getCompareUser=function(t){var e=this;if(e.getUserBySeat(t).opts.checkout){var a=(e.getUsers(),!0),r=!1,s=void 0;try{for(var n,i=u.values(this._users)[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){var o=n.value;if(0!==o.opts.bet[t]&&!o.opts.checkout)return o}}catch(t){r=!0,s=t}finally{try{!a&&i.return&&i.return()}finally{if(r)throw s}}e.first_seat=e.getNextSeatBySeat(t),e.first_seat==e.banker_seat&&(e.first_seat=e.getNextSeatBySeat(e.first_seat));var _=e.getUserBySeat(e.first_seat);return _.opts.checkout?null:_}var c=e.getUserBySeat(t);return c.opts.seat==e._banker_seat&&(e.first_seat=e.getNextSeatBySeat(c.opts.seat)),e.getUserBySeat(e.first_seat)},W.getNextSeatBySeat=function(t){return t-=0,this._player_count<++t?1:t},W.getUser=function(t){return this._users[t]},W.getUsers=function(){return this._users},W.getUserBySeat=function(t){return this._players[t]},W.isPlayer=function(t){return 0<t.opts.seat},W.isReady=function(t){return 0<t.opts.is_ready},W.isQuit=function(t){return 0<t.opts.is_quit},W.isStart=function(){return this._player_count<=this.getReadyCount()},W.getReadyCount=function(){var t=0,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;this.isReady(i)&&++t}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}return t},W.release=function(){return 1>this.getUserCount()},W.getUserCount=function(){return u.size(this._users)},W.isFull=function(){return this._player_count+this.visitor_count<=this.getUserCount()},W.isValidUser=function(t,e){var a=this,r=null;if(a.act_status!==e)return[r="STATUS_ERROR",null];var s=a.getUser(t);return s?a.act_seat!==s.opts.seat?[r="SEAT_ERROR",null]:[r,s]:[r="USER_ERROR",null]},function(){function t(t){var e=this._free_seat.shift();0<e&&(this._players[e]=t,t.opts.seat=e)}W.entry=function(e){var a=this;return a.getUser(e.id)?"已在房间":a.isFull()?"房间满员":(e.opts={},t.call(a,e),a._users[e.id]=e,e.opts.entry_time=(new Date).getTime(),e.opts.score=0,e.opts.is_quit=0,e.opts.is_ready=0,e.opts.bet=[0,0,0,0,0],e.opts.gold=0,e.opts.hacker=!1,e.opts.checkout=!1,e)}}(),W.re_entry=function(t){var e=this,a=e.getUser(t.id);return a?(a.opts.re_entry_time=(new Date).getTime(),a.opts.is_quit=0,a.server_id=t.server_id,a.channel_id=t.channel_id,a):"不在群组"},W.quit=function(t){var e=this,a=e.getUser(t);if(!a)return!0;if(e.isPlayer(a)){if(e.isStart())return a.opts.quit_time=(new Date).getTime(),a.opts.is_quit=1,!1;e._free_seat.push(a.opts.seat),delete e._players[a.opts.seat]}return delete e._users[t]},W.ready=function(e){var a=this;if(a.act_status!==d)return"AS_READY";if(a.isStart())return"已经开始";var r=a.getUser(e);return r?a.isPlayer(r)?a.isReady(r)?"已经举手":(r.opts.is_ready=1,a.isStart()&&(a.act_status=p,a.act_seat=a.banker_seat||1,a._cards_36=t()),a.delaytime=10,[a.getUsers(),[a.act_status,a.delaytime,a.act_seat]]):"不能举手":"用户不存在"},function(){function t(){var t=0,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){s.value.opts.craps&&t++}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}return t}function e(){var t=0,e=0,a=!0,r=!1,s=void 0;try{for(var n,i=u.values(this._players)[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){var o=n.value,_=o.opts.craps[0]-0+o.opts.craps[1];if(11<_)return o.opts.seat;t<=_&&(t=_,e=o.opts.seat)}}catch(t){r=!0,s=t}finally{try{!a&&i.return&&i.return()}finally{if(r)throw s}}return e}W.craps4=function(a){var r,s=this,n=s.isValidUser(a,p);return null==n[0]?r=n[1]:console.log(n[0]),r.opts.craps?"craps":(r.opts.craps=[u.random(1,6),u.random(1,6)],s._player_count<=t.call(s)&&(s.banker_seat=e.call(s),s.round_num++,s.act_seat=s.banker_seat),s.act_status=y,s.delaytime=5,[s.getUsers(),[s.act_status,s.delaytime,s.act_seat,r.opts.craps]])}}(),W.bankerBet=function(t,e){var a=this,r=a.isValidUser(t,b);return null==r[0]?r[1]:console.log(r[0]),a.act_status=v,a.act_seat=a.banker_seat,a.chips.length>0&&e>0&&(a.banker_bet=a.chips.shift()),a.chips.length>0&&e>2e3&&(a.banker_bet=a.chips.shift()),a.chips.length>0&&e>3e3&&(a.banker_bet=a.chips.shift()),a.delaytime=3,[a.getUsers(),[a.act_status,a.delaytime,a.act_seat,e]]},function(){function t(t,e){var a=(e[0]+e[1]-1+t)%4;return 0===a?4:a}W.bankerDice=function(e){var a=this;if(a.act_status!==k&&a.act_status!==A)return"AS_WAIT_FOR_BANKER_DICE";var r=a.getUser(e);return r?a.banker_seat!==r.opts.seat?"还没轮到你":(r.opts.craps=[u.random(1,6),u.random(1,6)],a.first_seat=t(a.banker_seat,r.opts.craps),a.act_status=g,a.delaytime=5,[a.getUsers(),[a.act_status,a.delaytime,a.act_seat,r.opts.craps]]):"用户不存在"}}(),function(){function t(t){return t}W.unBankerBet=function(e,a){var r=this;if(r.act_status!==U)return"AS_WAIT_FOR_PLAYER_BET";var s=r.getUser(e);if(!s)return"用户不存在";var n=a[0],i=a[1];return n=t.call(r,n),s.opts.bet[i]?"该玩家已下过注":(s.opts.bet[i]=n,r.delaytime=0,[r.getUsers(),[r.act_status,r.delaytime,s.opts.seat,n,i]])}}(),function(){function t(t){var e=this,a=e._cards_8[2*(t-1)],r=e._cards_8[2*(t-1)+1];return a!==r?(a+r)%10:10+a}W.compareCard=function(a){var r=this;return e({seat:r.banker_seat,bet:r.banker_bet,gold:r.getUserBySeat(r.banker_seat).gold_count,point:t.call(r,r.banker_seat)},{seat:r.first_seat,bet:a.opts.bet[r.first_seat],gold:a.gold_count,point:t.call(r,r.first_seat)})}}(),function(){W.banker_Continue=function(t,e){var a=this,r=a.getUser(t);return r?r.opts.seat!==a.banker_seat?"不是庄家":"true"===e?(a.act_status=k,a.act_seat=a.banker_seat,a.delaytime=10,[a.getUsers(),[a.act_status,a.delaytime,a.act_seat]]):(a.getUserBySeat(a.banker_seat).opts.checkout=!1,a.banker_seat=a.getNextSeatBySeat(a.banker_seat),a.banker_bet=0,a.round_num++,a.chips=[2e3,3e3,5e3],a.act_status=b,a.act_seat=a.banker_seat,a.delaytime=20,[a.getUsers(),[a.act_status,a.delaytime,a.act_seat]]):"用户不存在"}}(),function(){W.banker_Continue_Bet=function(t,e){var a=this,r=a.getUser(t);return r?r.opts.seat!==a.banker_seat?"不是庄家":(a.act_status=x,e-=0,a.chips.length>0&&e>2e3&&(a.banker_bet+=a.chips.shift()),a.chips.length>0&&e>3e3&&(a.banker_bet+=a.chips.shift()),a.delaytime=3,[a.getUsers(),[a.act_status,a.delaytime,a.banker_seat,a.banker_bet]]):"用户不存在"}}(),function(){W.delay_PlayerDice=function(){var t=this;return t.banker_seat>0?(t.act_status=b,t.delaytime=20,[t.getUsers(),[t.act_status,t.delaytime,t.banker_seat]]):(t.act_status=p,t.act_seat=t.getNextSeatBySeat(t.act_seat),t.delaytime=10,[t.getUsers(),[t.act_status,t.delaytime,t.act_seat]])}}(),function(){W.delay_BankerBet=function(){var t=this;return t.act_status=k,t.act_seat=t.banker_seat,t.delaytime=10,[t.getUsers(),[t.act_status,t.delaytime,t.act_seat]]}}(),function(){W.delay_BankerDice=function(){var t=this;return t.act_status=U,t.delaytime=20,[t.getUsers(),[t.act_status,t.delaytime]]}}(),function(){function t(t){var e=this,a=null,r=!0,s=!1,n=void 0;try{for(var i,o=u.values(e._users)[Symbol.iterator]();!(r=(i=o.next()).done);r=!0){var _=i.value;if(!0===_.opts.hacker){a=_;break}}}catch(t){s=!0,n=t}finally{try{!r&&o.return&&o.return()}finally{if(s)throw n}}if(null==a)return t;var c=0,l=!0,d=!1,f=void 0;try{for(var y,p=u.values(a.opts.bet)[Symbol.iterator]();!(l=(y=p.next()).done);l=!0){var h=y.value;if(h>0){c=h;break}}}catch(t){d=!0,f=t}finally{try{!l&&p.return&&p.return()}finally{if(d)throw f}}if(c>0){for(var v=0,b=0,m=0;m<4;m++){var g=t[2*m]!==t[2*m+1]?(t[2*m]+t[2*m+1])%10:10+t[2*m];g>v&&(v=g,b=m+1)}t[2*c],t[2*c+1];t[2*c]=t[2*b],t[2*c+1]=t[2*b+1],t[2*b]=t[2*eat],t[2*b+1]=t[2*c+1]}return t}W.delay_PlayerBet=function(){var e=this;return e.act_status=R,e._cards_8=e._cards_36.splice(0,8),e._card_8=t.call(e,e._card_8),e.delaytime=3,[e.getUsers(),[e.act_status,e.delaytime,e.first_seat,e._cards_8]]}}(),function(){W.delay_DealCard=function(){var t=this;t.act_status=C,t.first_seat==t.banker_seat&&(t.first_seat=t.getNextSeatBySeat(t.first_seat)),t.delaytime=1}}(),function(){W.delay_ComepareCard=function(){var t=this,e=t.getCompareUser(t.first_seat),a=t.getUserBySeat(t.banker_seat);if(null==e){t.act_status=w,a.opts.checkout=!0;var r=!0,s=!1,n=void 0;try{for(var i,o=u.values(t._users)[Symbol.iterator]();!(r=(i=o.next()).done);r=!0){var _=i.value;_.opts.checkout?_.gold_count+=_.opts.gold:t.result.push({id:_.id,nick:_.user_name,seat:_.opts.seat,gold:_.gold_count,score_count:_.opts.score})}}catch(t){s=!0,n=t}finally{try{!r&&o.return&&o.return()}finally{if(s)throw n}}return t.result.unshift({id:a.id,nick:a.user_name,seat:a.opts.seat,gold:a.gold_count,score_count:a.opts.score}),t.delaytime=20,[t.getUsers(),[t.act_status,t.delaytime,t.result]]}var c=t.compareCard(e);if(c[0]>0){var l=0;return t.curr_fund-0<t.fund-0&&(l=Math.round(.05*c[0]),t.curr_fund+=l),t.banker_bet+=c[0]-l,a.opts.score+=c[0]-l,e.opts.score+=c[1],e.opts.checkout=!0,t.result.push({id:e.id,nick:e.user_name,seat:e.opts.seat,gold:e.gold_count,score_count:e.opts.score}),a.opts.seat===c[2]&&(a.opts.gold=-1),t.delaytime=5,[t.getUsers(),[t.act_status,t.delaytime,[t.banker_bet,c[0],a.opts.seat,e.opts.seat,t.first_seat]]]}if(t.banker_bet+c[0]>0){var l=0;return t.curr_fund-0<t.fund-0&&(l=Math.round(.05*c[1]),t.curr_fund+=l),t.banker_bet+=c[0],a.opts.score+=c[0],e.opts.score+=c[1]-l,e.opts.checkout=!0,e.opts.seat===c[2]&&(e.opts.gold=-1),t.result.push({id:e.id,nick:e.user_name,seat:e.opts.seat,gold:e.gold_count,score_count:e.opts.score}),t.delaytime=5,[t.getUsers(),[t.act_status,t.delaytime,[t.banker_bet,c[0],a.opts.seat,e.opts.seat,t.first_seat]]]}var l=0;t.curr_fund-0<t.fund-0&&(l=Math.round(.05*t.banker_bet),t.curr_fund+=l);var d=t.banker_bet;return a.opts.score-=t.banker_bet,e.opts.score+=d-l,e.opts.bet[t.first_seat]-=t.banker_bet,t.banker_bet=0,t.chips.length>0?(t.act_status=D,t.delaytime=5,[t.getUsers(),[t.act_status,t.delaytime,[t.banker_bet,-d,a.opts.seat,e.opts.seat,t.first_seat]]]):(e.opts.checkout=!0,t.act_status=N,t.result.push({id:e.id,nick:e.user_name,seat:e.opts.seat,gold:e.gold_count,score_count:e.opts.score}),t.delaytime=5,[t.getUsers(),[t.act_status,t.delaytime,[t.banker_bet,-d,a.opts.seat,e.opts.seat,t.first_seat]]])}}(),function(){W.delay_ComepareCard2=function(){var t=this;return t.act_status=O,t.delaytime=20,[t.getUsers(),[t.act_status,t.delaytime,t.banker_seat]]}}(),function(){W.delay_ComepareCard3=function(){var t=this;t.act_status=L;var e=t.getUserBySeat(t.banker_seat);e.opts.checkout=!0;var a=!0,r=!1,s=void 0;try{for(var n,i=u.values(t._users)[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){var o=n.value;o.opts.checkout?o.gold_count+=o.opts.gold:t.result.push({id:o.id,nick:o.user_name,seat:o.opts.seat,gold:o.gold_count,score_count:o.opts.score})}}catch(t){r=!0,s=t}finally{try{!a&&i.return&&i.return()}finally{if(r)throw s}}return t.result.unshift({id:e.id,nick:e.user_name,seat:e.opts.seat,gold:e.gold_count,score_count:e.opts.score}),t.delaytime=20,[t.getUsers(),[t.act_status,t.delaytime,t.result]]}}(),function(){W.delay_BankerContinueBet=function(){var t=this;if(t.act_status=C,0==t.banker_bet)for(;t.chips.length>0;)t.chips.shift();return t.delaytime=3,t.act_status}}(),function(){function e(t){t.hand_num++,t.first_seat=t.banker_seat,t.act_seat=t.banker_seat,t.result.length=0;var e=!0,a=!1,r=void 0;try{for(var s,n=u.values(t.getUsers())[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;i.opts.seat!=t.banker_seat&&(i.opts.bet=[0,0,0,0,0],i.opts.checkout=!1)}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}console.log("rest hand")}function a(t){t.hand=1,t.first_seat=t.banker_seat,t.act_seat=t.banker_seat,t.result.length=0;var e=!0,a=!1,r=void 0;try{for(var s,n=u.values(t.getUsers())[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;i.opts.seat!=t.banker_seat&&(i.opts.bet=[0,0,0,0,0],i.opts.checkout=!1)}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}console.log("rest round")}W.delay_NextRound=function(){var r=this;switch(r.specialflag){case b:return r._cards_36=t(),a.call(r,r),r.getUserBySeat(r.banker_seat).opts.checkout=!1,r.banker_seat=r.getNextSeatBySeat(r.banker_seat),r.banker_bet=0,r.round_num++,r.chips=[2e3,3e3,5e3],r.act_status=b,r.delaytime=20,[r.getUsers(),[r.act_status,r.delaytime,r.banker_seat]];case P:return r._cards_36=t(),a.call(r,r),r.act_status=P,r.act_seat=r.banker_seat,r.delaytime=20,[r.getUsers(),[r.act_status,r.delaytime,r.act_seat]];case A:return e.call(r,r),r.act_status=k,r.act_seat=r.banker_seat,r.delaytime=10,[r.getUsers(),[r.act_status,r.delaytime,r.act_seat]]}}}(),function(){W.timeOut_PlayerDice=function(){var t=this;return t.craps4(t.getUserBySeat(t.act_seat).id)}}(),function(){W.timeOut_BankerBet=function(){var t=this,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;if(i.opts.seat==t.banker_seat)return t.bankerBet(i.id,200)}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}}}(),function(){W.timeOut_BankerDice=function(){var t=this,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;if(i.opts.seat==t.banker_seat)return t.bankerDice(i.id)}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}}}(),function(){W.timeOut_PlayerBet_Finish=function(){var t=this,e=[],a=!0,r=!1,s=void 0;try{for(var n,i=u.values(this._users)[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){var o=n.value;o.opts.seat!=t.banker_seat&&(t.isPlayer(o)?(0==o.opts.bet[o.opts.seat]&&(o.opts.bet[o.opts.seat]=10),e.push([o.id,o.opts.bet])):e.push([o.id,o.opts.bet]))}}catch(t){r=!0,s=t}finally{try{!a&&i.return&&i.return()}finally{if(r)throw s}}return t.act_status=E,t.delaytime=5,[t.getUsers(),[t.act_status,t.delaytime,e]]}}(),function(){W.timeOut_Banker_Continue_Bet=function(){var t=this,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;if(i.opts.seat==t.banker_seat)return t.banker_Continue_Bet(i.id,t.chips[0])}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}}}(),function(){W.timeOut_Next_Round=function(t){var e=this;if(e.round_num>=4*e.round_count){e.act_status=F;var a=!0,r=!1,s=void 0;try{for(var n,i=e._users[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){n.value.opts.is_ready=0}}catch(t){r=!0,s=t}finally{try{!a&&i.return&&i.return()}finally{if(r)throw s}}return e.delaytime=0,[e.getUsers(),[e.act_status,e.delaytime]]}return e.act_status=Y,e.delaytime=1,e.specialflag=A,4!=e.hand_num&&2!=t||(e.specialflag=2==t?b:P),[e.getUsers(),[e.act_status,e.delaytime,e.round_num,e.hand_num,e.specialflag]]}}(),function(){W.timeOut_Banker_Continue=function(){var t=this,e=!0,a=!1,r=void 0;try{for(var s,n=u.values(this._players)[Symbol.iterator]();!(e=(s=n.next()).done);e=!0){var i=s.value;if(i.opts.seat==t.banker_seat)return t.banker_Continue(i.id,!1)}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}}}();