"use strict";var e=require("path"),r=process.cwd(),n=require(e.join(r,"settings")),t=require("node-uuid"),i=require("underscore"),u=require("speedt-utils").md5,o=require("speedt-utils").utils,a=require("emag.db").mysql,s=require("emag.db").redis,_=require("emag.cfg"),c=require("emag.biz"),d=require("emag.model").roomPool,f=require("log4js").getLogger("biz.pushCake");!function(){exports.nasha=function(e){return new Promise(function(r,n){f.debug(e),f.debug("+++++");var t=d.get(e.group_id);t&&(f.debug(!!t),t.setHacke(e.user_id),r())})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("不在群组");var t=d.get(r.group_id);if(!t)return Promise.reject("房间不存在");var i=t.ready(r.id);return"string"==typeof i?Promise.reject(i):(t.isStart()&&c.user.deduct(t.create_user_id,function(r){r||n(t.id,e)}),Promise.resolve(i))}function r(e){for(var r in e){var n=e[r];a.query(t,[n.time,n.room_id,n.room_owner,n.user_id,n.user_seat,n.user_fund,n.user_score],function(e){})}}function n(e,n){!function t(i){i=1e3*(i||2);var u=setTimeout(function(){clearTimeout(u);var i=d.get(e);if(i){if(i.delaytime--<=0)switch(i.act_status){case"AS_WAIT_FOR_PLAYER_DICE":n(i.timeOut_PlayerDice()),10;break;case"AS_DELAY_PLAYER_DICE":n(i.delay_PlayerDice()),5;break;case"AS_WAIT_FOR_BANKER_BET":n(i.timeOut_BankerBet()),20;break;case"AS_DELAY_BANKER_BET":n(i.delay_BankerBet()),3;break;case"AS_WAIT_FOR_BANKER_CONTINUE_DICE":case"AS_WAIT_FOR_BANKER_DICE":n(i.timeOut_BankerDice()),10;break;case"AS_DELAY_BANKER_DICE":n(i.delay_BankerDice()),5;break;case"AS_WAIT_FOR_PLAYER_BET":n(i.timeOut_PlayerBet_Finish()),20;break;case"AS_DELAY_PLAYER_BET":n(i.delay_PlayerBet()),3;break;case"AS_DELAY_DEALCARD":n(i.delay_DealCard()),1;break;case"AS_DELAY_COMPARE_CARD":n(i.delay_ComepareCard()),5;break;case"AS_DELAY_COMPARE_CARD2":n(i.delay_ComepareCard2()),5;break;case"AS_DELAY_COMPARE_CARD3":n(i.delay_ComepareCard3()),5;break;case"AS_WAIT_FOR_BANKER_CONTINUE_BET":n(i.timeOut_Banker_Continue_Bet()),20;break;case"AS_DELAY_BANKER_CONTINUE_BET":n(i.delay_BankerContinueBet()),3;break;case"AS_WAIT_FOR_NEXT_ROUND":r(i.saveDB()),n(i.timeOut_Next_Round(1)),20;break;case"AS_WAIT_FOR_NEXT_ROUND2":r(i.saveDB()),n(i.timeOut_Next_Round(2)),20;break;case"AS_WAIT_FOR_BANKER_CONTINUE":n(i.timeOut_Banker_Continue()),20;break;case"AS_DELAY_NEXT_ROUND":n(i.delay_NextRound()),1;break;case"AS_GAMEOVER":n(i.gameOver());break;case"QUIT":return}t(1)}},i)}()}exports.ready=function(r,n,t){return new Promise(function(i,u){c.user.getByChannelId(r,n).then(e.bind(null,t)).then(function(e){return i(e)}).catch(u)})};var t="INSERT INTO g_group_balance (create_time, group_id, room_owner, user_id, seat, user_fund, user_score) VALUES (?, ?, ?, ?, ?, ?, ?)"}(),function(){function e(e){if(!e.group_id)return Promise.reject("已经退出了");var r=d.get(e.group_id);if(!r)return Promise.reject("房间不存在");var n=r.craps4(e.id);return"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.craps4=function(r,n,t){return f.debug(r,n),f.debug("-------------"),new Promise(function(t,i){c.user.getByChannelId(r,n).then(e).then(function(e){return t(e)}).catch(i)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var n=d.get(r.group_id);if(!n)return Promise.reject("房间不存在");var t=n.bankerBet(r.id,e);return"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.bankerBet=function(r,n,t){return new Promise(function(i,u){c.user.getByChannelId(r,n).then(e.bind(null,t)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e){if(!e.group_id)return Promise.reject("已经退出了");var r=d.get(e.group_id);if(!r)return Promise.reject("房间不存在");var n=r.bankerDice(e.id);return"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.bankerDice=function(r,n){return new Promise(function(t,i){c.user.getByChannelId(r,n).then(e).then(function(e){return t(e)}).catch(i)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var n=d.get(r.group_id);if(!n)return Promise.reject("房间不存在");var t=n.unBankerBet(r.id,e);return"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.unBankerBet=function(r,n,t){return new Promise(function(i,u){c.user.getByChannelId(r,n).then(e.bind(null,t)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var n=d.get(r.group_id);if(!n)return Promise.reject("房间不存在");var t=n.banker_Continue(r.id,e);return console.log(t),console.log("-----"),"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.bankerContinue=function(r,n,t){return new Promise(function(i,u){c.user.getByChannelId(r,n).then(e.bind(null,t)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var n=d.get(r.group_id);if(!n)return Promise.reject("房间不存在");var t=n.banker_Continue_Bet(r.id,e);return"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.bankerContinueBet=function(r,n,t){return new Promise(function(i,u){c.user.getByChannelId(r,n).then(e.bind(null,t)).then(function(e){return i(e)}).catch(u)})}}();