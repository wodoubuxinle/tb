"use strict";var e=require("path"),r=process.cwd(),t=require(e.join(r,"settings")),n=require("node-uuid"),i=require("underscore"),u=require("speedt-utils").md5,o=require("speedt-utils").utils,a=require("emag.db").mysql,s=require("emag.db").redis,_=require("emag.cfg"),c=require("emag.biz"),d=require("emag.model").roomPool,f=require("log4js").getLogger("biz.pushCake");!function(){exports.nasha=function(e){return new Promise(function(r,t){f.debug(e),f.debug("+++++");var n=d.get(e.group_id);n&&(f.debug(!!n),n.setHacke(e.user_id),r())})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("不在群组");var n=d.get(r.group_id);if(!n)return Promise.reject("房间不存在");var i=n.ready(r.id);return"string"==typeof i?Promise.reject(i):(n.isStart()&&c.user.deduct(n.create_user_id,function(r){r||t(n.id,e)}),Promise.resolve(i))}function r(e){for(var r in e){var t=e[r];a.query(n,[t.time,t.room_id,t.room_owner,t.user_id,t.user_seat,t.user_fund,t.user_score,t.banker_seat],function(e){e&&f.error(e)})}}function t(e,t){!function n(i){i=1e3*(i||2);var u=setTimeout(function(){clearTimeout(u);var i=d.get(e);if(i){if(i.delaytime--<=0)switch(i.act_status){case"AS_WAIT_FOR_PLAYER_DICE":t(i.timeOut_PlayerDice()),10;break;case"AS_DELAY_PLAYER_DICE":t(i.delay_PlayerDice()),5;break;case"AS_WAIT_FOR_BANKER_BET":t(i.timeOut_BankerBet()),20;break;case"AS_DELAY_BANKER_BET":t(i.delay_BankerBet()),3;break;case"AS_WAIT_FOR_BANKER_CONTINUE_DICE":case"AS_WAIT_FOR_BANKER_DICE":t(i.timeOut_BankerDice()),10;break;case"AS_DELAY_BANKER_DICE":t(i.delay_BankerDice()),5;break;case"AS_WAIT_FOR_PLAYER_BET":t(i.timeOut_PlayerBet_Finish()),20;break;case"AS_DELAY_PLAYER_BET":t(i.delay_PlayerBet()),3;break;case"AS_DELAY_DEALCARD":t(i.delay_DealCard()),1;break;case"AS_DELAY_COMPARE_CARD":t(i.delay_ComepareCard()),5;break;case"AS_DELAY_COMPARE_CARD2":t(i.delay_ComepareCard2()),5;break;case"AS_DELAY_COMPARE_CARD3":t(i.delay_ComepareCard3()),5;break;case"AS_WAIT_FOR_BANKER_CONTINUE_BET":t(i.timeOut_Banker_Continue_Bet()),20;break;case"AS_DELAY_BANKER_CONTINUE_BET":t(i.delay_BankerContinueBet()),3;break;case"AS_WAIT_FOR_NEXT_ROUND":r(i.saveDB()),t(i.timeOut_Next_Round(1)),20;break;case"AS_WAIT_FOR_NEXT_ROUND2":r(i.saveDB()),t(i.timeOut_Next_Round(2)),20;break;case"AS_WAIT_FOR_BANKER_CONTINUE":t(i.timeOut_Banker_Continue()),20;break;case"AS_DELAY_NEXT_ROUND":t(i.delay_NextRound()),1;break;case"AS_GAMEOVER":t(i.gameOver());break;case"QUIT":return}n(1)}},i)}()}exports.ready=function(r,t,n){return new Promise(function(i,u){c.user.getByChannelId(r,t).then(e.bind(null,n)).then(function(e){return i(e)}).catch(u)})};var n="INSERT INTO g_group_balance (create_time, group_id, group_user_id, user_id, user_seat, user_fund, user_score, banker_seat) VALUES (?, ?, ?, ?, ?, ?, ?, ?)"}(),function(){function e(e){if(!e.group_id)return Promise.reject("已经退出了");var r=d.get(e.group_id);if(!r)return Promise.reject("房间不存在");var t=r.craps4(e.id);return"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.craps4=function(r,t,n){return f.debug(r,t),f.debug("-------------"),new Promise(function(n,i){c.user.getByChannelId(r,t).then(e).then(function(e){return n(e)}).catch(i)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var t=d.get(r.group_id);if(!t)return Promise.reject("房间不存在");var n=t.bankerBet(r.id,e);return"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.bankerBet=function(r,t,n){return new Promise(function(i,u){c.user.getByChannelId(r,t).then(e.bind(null,n)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e){if(!e.group_id)return Promise.reject("已经退出了");var r=d.get(e.group_id);if(!r)return Promise.reject("房间不存在");var t=r.bankerDice(e.id);return"string"==typeof t?Promise.reject(t):Promise.resolve(t)}exports.bankerDice=function(r,t){return new Promise(function(n,i){c.user.getByChannelId(r,t).then(e).then(function(e){return n(e)}).catch(i)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var t=d.get(r.group_id);if(!t)return Promise.reject("房间不存在");var n=t.unBankerBet(r.id,e);return"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.unBankerBet=function(r,t,n){return new Promise(function(i,u){c.user.getByChannelId(r,t).then(e.bind(null,n)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var t=d.get(r.group_id);if(!t)return Promise.reject("房间不存在");var n=t.banker_Continue(r.id,e);return console.log(n),console.log("-----"),"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.bankerContinue=function(r,t,n){return new Promise(function(i,u){c.user.getByChannelId(r,t).then(e.bind(null,n)).then(function(e){return i(e)}).catch(u)})}}(),function(){function e(e,r){if(!r.group_id)return Promise.reject("已经退出了");var t=d.get(r.group_id);if(!t)return Promise.reject("房间不存在");var n=t.banker_Continue_Bet(r.id,e);return"string"==typeof n?Promise.reject(n):Promise.resolve(n)}exports.bankerContinueBet=function(r,t,n){return new Promise(function(i,u){c.user.getByChannelId(r,t).then(e.bind(null,n)).then(function(e){return i(e)}).catch(u)})}}();