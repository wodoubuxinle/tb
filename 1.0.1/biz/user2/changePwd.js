"use strict";var e=require("path"),r=process.cwd(),s=require(e.join(r,"settings")),u=require("node-uuid"),i=require("speedt-utils").md5,t=require("speedt-utils").utils,n=require("emag.db").mysql,o=require("emag.db").redis,c=require("emag.cfg"),d=require("emag.biz"),a=require("underscore");a.str=require("underscore.string"),a.mixin(a.str.exports()),function(){function e(e,r){return i.hex(e.old_pass)!==r.user_pass?Promise.reject("原始密码错误"):Promise.resolve()}function r(e){return e.user_pass=i.hex(e.user_pass),new Promise(function(r,u){n.query(s,[e.user_pass,e.id],function(e){if(e)return u(e);r()})})}exports=module.exports=function(s){return a.isString(s.user_pass)?(s.user_pass=a.trim(s.user_pass),""===s.user_pass?Promise.reject("INVALID_PARAMS"):new Promise(function(u,i){d.user2.getById(s.id).then(e.bind(null,s)).then(r.bind(null,s)).then(function(){return u(s)}).catch(i)})):Promise.reject("INVALID_PARAMS")};var s="UPDATE s_user set user_pass=? WHERE id=?"}();