"use strict";var n=require("path"),e=process.cwd(),r=require(n.join(e,"settings")),t=require("node-uuid"),i=require("speedt-utils").md5,u=require("speedt-utils").utils,o=require("emag.db").mysql,c=require("emag.db").redis,s=require("emag.lib").anysdk,a=require("emag.cfg"),f=require("emag.biz"),d=require("underscore");d.str=require("underscore.string"),d.mixin(d.str.exports());var _=require("log4js").getLogger("biz.user");!function(){function n(n){return d.isString(n.user_id)&&d.isString(n.product_id)&&d.isString(n.order_id)?(n.goods_id=n.product_id,Promise.resolve(n)):Promise.reject("INVALID_PARAMS")}function e(n){return new Promise(function(e,t){o.beginTransaction().then(r.bind(null,n)).then(function(){return e()}).catch(t)})}function r(n,e){return new Promise(function(r,i){f.user_payment.saveNew(n,e).then(t.bind(null,n,e)).then(o.commitTransaction.bind(null,e)).then(function(){return r()}).catch(function(n){e.rollback(function(){return i(n)})})})}function t(n,e){return new Promise(function(r,t){f.goods.findDetailById(n.goods_id,e).then(f.user.editPayment.bind(null,n.user_id,e)).then(function(){return r()}).catch(t)})}exports.payment=function(r){return s.payment(r)?new Promise(function(t,i){n(r).then(e).then(function(){return t()}).catch(i)}):Promise.reject("ERROR")}}(),function(){function n(n){var r=[],t=[],i=!0,u=!1,o=void 0;try{for(var c,s=n[Symbol.iterator]();!(i=(c=s.next()).done);i=!0){var a=c.value;r.push(e(a.game_prop_id)+"="+e(a.game_prop_id)+"+?"),t.push(a.num)}}catch(n){u=!0,o=n}finally{try{!i&&s.return&&s.return()}finally{if(u)throw o}}return[r.join(","),t]}function e(n){switch(n){case"3":return"current_score";case"4":return"gold_count"}}exports.editPayment=function(e,r,t){var i=n(t),u="UPDATE s_user SET ";u+=i[0],u+=" WHERE id=?";var c=i[1];return c.push(e),new Promise(function(n,e){(r||o).query(u,c,function(r){if(r)return e(r);n()})})}}(),function(){exports.findAll=function(n,e){o.query("SELECT a.* FROM s_user a WHERE a.status=? ORDER BY a.create_time DESC",[n],e)}}(),function(){function n(n,r,t){o.query(e,[r,new Date,n],t)}exports.del=function(e,r){n(e,0,r)};var e="UPDATE s_user SET status=?, status_time=? WHERE id=?"}(),function(){exports.resetPwd=function(n,e,r){o.query("UPDATE s_user SET user_pass=? WHERE id=?",[i.hex(e||"123456"),n],r)}}(),function(){function n(n,i){return new Promise(function(o,s){c.evalsha(e,t,r.redis.database,n,i,function(n,e){return n?s(n):d.isArray(e)?void o(u.arrToObj(e)):s(e)})})}exports.logout=function(e,r){return new Promise(function(t,i){n(e,r).then(f.group.quit.bind(null,e,r)).then(function(n){return t(n)}).catch(i)})};var e="6f3e8fc00771defac1a08fd0d7f2aa97e9734f37",t=3}(),function(){function n(n,e){return e?1!==e.status?Promise.reject("禁用状态"):i.hex(n.user_pass)!==e.user_pass?Promise.reject("用户名或密码输入错误"):Promise.resolve(e):Promise.reject("用户不存在")}function e(n){return new Promise(function(e,r){Promise.all([o(n),f.frontend.available()]).then(function(n){return e(n)}).catch(r)})}function o(n){return new Promise(function(e,i){c.evalsha(s,a,r.redis.database,r.app.client_id,n.id,u.replaceAll(t.v4(),"-",""),d,function(n,r){if(n)return i(n);e(r)})})}exports.login=function(r){return new Promise(function(t,i){f.user.getByName(r.user_name).then(n.bind(null,r)).then(e).then(function(n){return t(n)}).catch(i)})};var s="5d6ae7790c5575549e66e87a5bc40cb3c8e182dc",a=4,d=5}(),function(){function n(n){var r=d.clone(n);return new Promise(function(t,i){f.user.getById(n.data.user_info.openid).then(e.bind(null,n.data.user_info)).then(function(){return t(r)}).catch(i)})}function e(n,e){return e?(e.original_data=JSON.stringify(n),e.nickname=n.nickname,e.sex=n.sex,e.weixin=n.unionid,e.weixin_avatar=n.headimgurl,new Promise(function(n,t){o.query(r,[e.nickname,e.sex,e.original_data,e.weixin,e.weixin_avatar,e.id],function(r){if(r)return t(r);n(e)})})):f.user.registerWX(n)}exports.wx=function(e){return new Promise(function(r,t){s.wx(e).then(n).then(function(n){return r(n)}).catch(t)})};var r="UPDATE s_user SET nickname=?, sex=?, original_data=?, weixin=?, weixin_avatar=? WHERE id=?"}(),function(){function n(n,r){return new Promise(function(t,i){(r||o).query(e,[n.server_id,n.channel_id,n.id],function(e){if(e)return i(e);t(n)})})}exports.registerChannel=function(e,r){return new Promise(function(t,i){f.user.getByRedisChannelId(e,r).then(n).then(function(n){return t(n)}).catch(i)})};var e="UPDATE s_user SET server_id=?, channel_id=? WHERE id=?";exports.clearChannel=function(e,r){return n({server_id:"",channel_id:"",id:e},r)}}(),function(){exports.getById=function(n,e){return new Promise(function(r,t){(e||o).query("SELECT a.* FROM s_user a WHERE a.id=?",[n],function(n,e){if(n)return t(n);r(o.checkOnly(e)?e[0]:null)})})}}(),function(){exports.getByRedisChannelId=function(n,e){return new Promise(function(t,i){c.evalsha("f09fa3f6a5991a98252bd4675a71e34879edda7a",3,r.redis.database,n,e,function(n,e){return n?i(n):d.isArray(e)?void t(u.arrToObj(e)):i(e)})})}}(),function(){exports.deduct=function(n,e){o.query("UPDATE s_user SET gold_count=gold_count-5 WHERE id=?",[n],function(n){if(n)return e(n);e()})}}(),function(){exports.editInfo=function(n,e){return n.current_score=n.current_score||0,n.vip=n.vip||0,n.gold_count=n.gold_count||0,new Promise(function(r,t){(e||o).query("UPDATE s_user SET nickname=?, current_score=?, vip=?, gold_count=gold_count+? WHERE id=?",[n.nickname,n.current_score,n.vip,n.gold_count,n.id],function(e){if(e)return t(e);r(n)})})}}(),function(){function n(n){return n?Promise.reject("用户名已存在"):Promise.resolve()}function e(n){return n.id=n.id||u.replaceAll(t.v1(),"-",""),n.user_pass=i.hex(n.user_pass),n.status=1,n.create_time=new Date,n.current_score=0,n.vip=0,n.consume_count=0,n.win_count=0,n.lose_count=0,n.win_score_count=0,n.lose_score_count=0,n.line_gone_count=0,n.gold_count=100,new Promise(function(e,r){o.query(s,[n.id,n.user_name,n.user_pass,n.status,n.create_time,n.mobile,n.weixin,n.weixin_avatar,n.current_score,n.nickname,n.vip,n.consume_count,n.win_count,n.lose_count,n.win_score_count,n.lose_score_count,n.line_gone_count,n.gold_count,n.original_data,n.user_code],function(t){if(t)return r(t);e(n)})})}var r=/^[\u4E00-\u9FA5a-zA-Z0-9_]{2,10}$/,c=/^[a-zA-Z0-9_]{6,16}$/;exports.registerWX=function(n){return n.original_data=JSON.stringify(n),n.id=n.openid,n.user_name=n.openid,n.user_pass="123456",n.weixin=n.unionid,n.weixin_avatar=n.headimgurl,new Promise(function(r,t){f.user.genFreeUserCode().then(function(e){return n.user_code=e,Promise.resolve(n)}).then(e).then(function(n){return r(n)}).catch(t)})},exports.register=function(t){return t=t||{},d.isString(t.user_name)?(t.user_name=d.trim(t.user_name),r.test(t.user_name)&&d.isString(t.user_pass)?(t.user_pass=d.trim(t.user_pass),c.test(t.user_pass)?(delete t.id,new Promise(function(r,i){f.user.getByName(t.user_name).then(n).then(e.bind(null,t)).then(function(n){return r(n)}).catch(i)})):Promise.reject("INVALID_PARAMS")):Promise.reject("INVALID_PARAMS")):Promise.reject("INVALID_PARAMS")};var s="INSERT INTO s_user (id, user_name, user_pass, status, create_time, mobile, weixin, weixin_avatar, current_score, nickname, vip, consume_count, win_count, lose_count, win_score_count, lose_score_count, line_gone_count, gold_count, original_data, user_code) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"}(),function(){exports.getByName=function(n,e){return new Promise(function(r,t){(e||o).query("SELECT a.* FROM s_user a WHERE a.user_name=?",[n],function(n,e){if(n)return t(n);r(o.checkOnly(e)?e[0]:null)})})}}(),function(){function n(n,t){return n.group_entry_time=(new Date).getTime(),n.backend_id=r.app.id,new Promise(function(r,i){(t||o).query(e,[n.backend_id,n.group_id,n.group_entry_time,n.id],function(e){if(e)return i(e);r(n)})})}exports.entryGroup=function(e,r){return n(e,r)},exports.createGroup=function(e,r){return n(e,r)};var e="UPDATE s_user SET backend_id=?, group_id=?, group_entry_time=? WHERE id=?";exports.quitGroup=function(e,r){return n({group_id:"",id:e},r)}}(),function(){function n(e,r){var t=d.random(1e5,999999);f.user.findAllByGroupId(t,r).then(function(i){if(0<i.length)return n(e,r);e(null,t)}).catch(e)}exports.genFreeGroupId=function(e){return new Promise(function(r,t){n(function(n,e){if(n)return t(n);r(e)},e)})}}(),function(){exports.findAllByGroupId=function(n,e){return new Promise(function(r,t){(e||o).query("SELECT a.* FROM s_user a WHERE a.group_id=? ORDER BY a.group_entry_time ASC",[n],function(n,e){if(n)return t(n);r(e)})})}}(),function(){exports.getByChannelId=function(n,e){return new Promise(function(r,t){o.query("SELECT a.* FROM s_user a WHERE a.server_id=? AND a.channel_id=?",[n,e],function(n,e){return n?t(n):o.checkOnly(e)?void r(e[0]):t("通道不存在")})})}}(),function(){function n(r,t){var i=u.randomStr(6).toUpperCase();o.query(e,[i],function(e,u){return e?r(e):0<u.length?n(r,t):void r(null,i)})}var e="SELECT * FROM s_user WHERE user_code=?";exports.genFreeUserCode=function(e){return new Promise(function(r,t){n(function(n,e){if(n)return t(n);r(e)},e)})}}();