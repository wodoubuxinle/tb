"use strict";var e=require("path"),r=process.cwd(),t=require(e.join(r,"settings")),n=require("node-uuid"),i=require("speedt-utils").md5,u=require("speedt-utils").utils,o=require("emag.db").mysql,s=require("emag.db").redis,c=require("emag.cfg"),a=require("emag.biz"),d=require("underscore");d.str=require("underscore.string"),d.mixin(d.str.exports());var f=require("emag.model").roomPool,_=require("log4js").getLogger("biz.group");!function(){function e(e,r){return r.group_id?Promise.reject("MUST_BE_QUIT"):(r.group_id=e.id,Promise.resolve(r))}function r(e,r){var t=e.entry(r);if("string"==typeof t)return Promise.reject(t);var n=[],i=!0,u=!1,o=void 0;try{for(var s,c=d.values(e.getUsers())[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var a=s.value;n.push([a.id,a.opts.seat,a.nickname,a.weixin_avatar])}}catch(e){u=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(u)throw o}}return Promise.resolve([e.getUsers(),[[e.id,e.name,e.fund,e.round_count,e.visitor_count,e.banker_seat,e.round_pno,e.round_no,e.round_no_first_seat,e.getReadyCount(),e.act_status,e.act_seat],n]])}exports.entry=function(t,n,i){var u=f.get(i);return u?new Promise(function(i,o){a.user.getByChannelId(t,n).then(e.bind(null,u)).then(a.user.entryGroup).then(r.bind(null,u)).then(function(e){return i(e)}).catch(o)}):Promise.reject("房间不存在")}}(),function(){function e(e){return e.group_id?Promise.reject("MUST_BE_QUIT"):new Promise(function(r,t){a.user.genFreeGroupId().then(function(t){e.group_id=t,r(e)}).catch(t)})}function r(e,r){return e.id=r.group_id,e.create_user_id=r.id,new Promise(function(n,i){a.user.createGroup(r).then(t.bind(null,e)).then(function(e){return n(e)}).catch(i)})}function t(e,r){var t=f.create(e);if(!t)return Promise.reject("创建房间失败");var n=t.entry(r);return"string"==typeof n?Promise.reject(n):Promise.resolve([[t.id,t.name,t.fund,t.round_count,t.visitor_count,t.banker_seat,t.round_pno,t.round_no,t.round_no_first_seat,t.getReadyCount(),t.act_status,t.act_seat],[n.id,n.opts.seat,n.nickname,n.weixin_avatar]])}exports.search=function(t,n,i){return i=i||{},d.isNumber(i.visitor_count)?6<i.visitor_count||0>i.visitor_count?Promise.reject("INVALID_PARAMS"):d.isNumber(i.fund)?999999<i.fund||0>i.fund?Promise.reject("INVALID_PARAMS"):d.isNumber(i.round_count)?4<i.round_count||1>i.round_count?Promise.reject("INVALID_PARAMS"):new Promise(function(u,o){a.user.getByChannelId(t,n).then(e).then(r.bind(null,i)).then(function(e){return u(e)}).catch(o)}):Promise.reject("INVALID_PARAMS"):Promise.reject("INVALID_PARAMS"):Promise.reject("INVALID_PARAMS")}}(),function(){function e(e){if(!e.group_id)return Promise.reject("不在群组");var r=f.get(e.group_id);return r?r.quit(e.id)?new Promise(function(t,n){a.user.quitGroup(e.id).then(function(){if(1>d.size(r.getUsers()))return t();t([r.getUsers(),e.id])}).catch(n)}):Promise.resolve([r.getUsers(),e.id]):new Promise(function(r,t){a.user.quitGroup(e.id).then(function(){return r()}).catch(t)})}exports.quit=function(r,t){return new Promise(function(n,i){a.user.getByChannelId(r,t).then(e).then(function(e){return n(e)}).catch(i)})}}(),function(){function e(e){if(!e.group_id)return Promise.reject("已经退出");var r=f.get(e.group_id);if(!r)return Promise.reject("房间不存在");var t=r.re_entry(e);return"string"==typeof t?Promise.reject(t):Promise.resolve([r.getUsers(),[t.id,t.opts.seat]])}exports.re_entry=function(r,t){return new Promise(function(n,i){a.user.getByChannelId(r,t).then(e).then(function(e){return n(e)}).catch(i)})}}();