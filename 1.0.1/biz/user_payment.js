"use strict";var e=require("path"),r=process.cwd(),i=require(e.join(r,"settings")),s=require("node-uuid"),t=require("speedt-utils").md5,d=require("speedt-utils").utils,u=require("emag.db").mysql,a=require("emag.db").redis,n=require("emag.cfg"),o=require("emag.biz"),_=require("underscore");_.str=require("underscore.string"),_.mixin(_.str.exports());var c=require("log4js").getLogger("biz.user_payment");!function(){exports.saveNew=function(e,r){return e.id=d.replaceAll(s.v1(),"-",""),e.create_time=new Date,e.original_data=JSON.stringify(e),new Promise(function(i,s){(r||u).query("INSERT INTO s_user_payment (id, user_id, goods_id, create_time, order_id, original_data) VALUES (?, ?, ?, ?, ?, ?)",[e.id,e.user_id,e.goods_id,e.create_time,e.order_id,e.original_data],function(r,t){if(r)return s(r);i(e)})})}}(),function(){exports.findAllByUserId=function(e,r){u.query("SELECT c.goods_name, b.user_name, a.* FROM (SELECT * FROM s_user_payment WHERE user_id=?) a LEFT JOIN s_user b ON (a.user_id=b.id) LEFT JOIN w_goods c ON (a.goods_id=c.id) WHERE b.id IS NOT NULL AND c.id IS NOT NULL ORDER BY a.create_time DESC",[e],r)}}();